pipeline {

    agent none

    options {
        skipStagesAfterUnstable()
    }

    stages {

        stage('Get Code') {
            agent { label 'master' }
            steps {
                deleteDir()

                sh '''
                    whoami
                    hostname
                '''

                git branch: 'develop', url: 'https://github.com/AlfredoVG77/todo-list-aws.git'

                stash name: 'code', includes: '**/*'
            }
        }

        stage('Static Test') {
            agent { label 'test' }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {

                    unstash 'code'

                    sh '''
                        whoami
                        hostname
                    '''

                    //
                    // FLAKE8
                    //
                    sh '''
                        . /var/lib/jenkins/venv/bin/activate

                        echo "# flake8 report" > flake8.out
                        python -m flake8 --format=pylint src >> flake8.out

                        echo "=== FLAKE8 OUT ==="
                        ls -l flake8.out
                        cat flake8.out
                    '''

                    recordIssues(
                        tools: [flake8(pattern: 'flake8.out')]
                    )

                    stash name: 'flake8-res', includes: 'flake8.out'

                    //
                    // BANDIT
                    //
                    sh '''
                        . /var/lib/jenkins/venv/bin/activate

                        python -m bandit -r src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"

                        echo "=== BANDIT OUT ==="
                        ls -l bandit.out
                        cat bandit.out
                    '''

                    recordIssues(
                        tools: [pyLint(pattern: 'bandit.out')]
                    )

                    stash name: 'bandit-res', includes: 'bandit.out'
                }
            }
        }

        stage('Deploy to Staging') {
            agent { label 'master' }
            steps {
                unstash 'code'

                sh '''
                    echo '=== SAM BUILD ==='
                    sam build --template-file template.yaml
                    sam validate --region us-east-1

                    echo '=== SAM DEPLOY TO STAGING ==='
                    sam deploy --stack-name todo-list-aws-staging --region us-east-1 --capabilities CAPABILITY_IAM --resolve-s3 --s3-prefix todo-list-aws --parameter-overrides Stage=staging --no-fail-on-empty-changeset --no-confirm-changeset || true
                '''

                //
                // Obtener URL del API y guardarla para el siguiente agente
                //
                sh '''
                    BASE_URL=$(aws cloudformation describe-stacks --stack-name todo-list-aws-staging --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" --region us-east-1 --output text)

                    echo "$BASE_URL" > api_url.txt
                    echo "API URL: $BASE_URL"
                '''

                stash name: 'api-url', includes: 'api_url.txt'
            }
        }

        stage('API Tests') {
            agent { label 'test' }
            steps {

                unstash 'code'
                unstash 'api-url'

                sh '''
                    whoami
                    hostname

                    BASE_URL=$(cat api_url.txt)
                    echo "=== BASE_URL OBTENIDA ==="
                    echo "$BASE_URL"

                    . /var/lib/jenkins/venv/bin/activate
                    export BASE_URL="$BASE_URL"

                    pytest test/integration/todoApiTest.py --junitxml=api-tests.xml -q --disable-warnings --maxfail=1
                '''

                junit 'api-tests.xml'
            }
        }

        stage('Promote to master') {
            agent { label 'master' }
            steps {
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        echo "=== Actualizando develop ==="

                        git config user.email "jenkins@ci"
                        git config user.name "Jenkins CI"

                        git checkout develop

                        LAST_VERSION=$(grep -oP '^## \\[\\K[0-9]+\\.[0-9]+\\.[0-9]+' CHANGELOG.md | head -n 1)
                        NEW_VERSION=$(echo $LAST_VERSION | awk -F. '{$NF+=1; OFS="."; print}')
                        TODAY=$(date +%Y-%m-%d)

                        awk -v ver="$NEW_VERSION" -v date="$TODAY" '
                            NR==1 {print; print ""; print "## [" ver "] - " date; print "### Changed"; print "- Actualización automática en develop."; next}
                            {print}
                        ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

                        git add CHANGELOG.md
                        git commit -m "Update CHANGELOG in develop - version $NEW_VERSION" || true

                        git remote set-url origin https://AlfredoVG77:${GITHUB_TOKEN}@github.com/AlfredoVG77/cp1-4-res.git
                        git push origin develop

                        echo "=== Promocionando a master ==="

                        git fetch origin master
                        git checkout master

                        # 1. Eliminar Jenkinsfile_agents del índice
                        git rm --cached Jenkinsfile_agents || true
			git rm --cached Jenkinsfile || true
                        git commit -m "Preparar merge: excluir Jenkinsfile_agents" || true

                        # 2. Restaurar Jenkinsfile_agents de master
                        git checkout origin/master -- Jenkinsfile_agents
                        git checkout origin/master -- Jenkinsfile
                        git add Jenkinsfile_agents Jenkinsfile
                        git commit -m "Restaurar Jenkinsfile_agents de master antes del merge" || true

                        # 3. Merge sin conflictos
                        git merge origin/develop --no-edit || true

                        # 4. Restaurar Jenkinsfile_agents por seguridad
                        git checkout origin/master -- Jenkinsfile_agents
			git checkout origin/master -- Jenkinsfile
                        git add Jenkinsfile_agents Jenkinsfile
                        git commit -m "Mantener Jenkinsfile_agents de master" || true

                        git push origin master
                    '''
                }
            }
        }
    }
}
